Reduced widget code from ~1500 to ~600 lines, fixed reset mechanism, improved shadowRoot handling